<!DOCTYPE html>
<html>
  <head>
    <title>Ahoy - Simple, Powerful Visit Tracking for Rails</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="github.css">
    <style>
      body {
        padding-bottom: 20px;
      }

      .container {
        max-width: 800px;
      }

      h2, h3, h4 {
        margin-top: 1em;
      }

      p {
        margin-top: 1.5em;
        margin-bottom: 1.5em;
      }

      p.lead {
        margin-top: 0;
      }
    </style>

    <meta property="og:title" content="Ahoy"/>
    <meta property="og:url" content="http://ankane.github.io/ahoy/"/>
    <meta property="og:image" content="https://github.global.ssl.fastly.net/images/gravatars/gravatar-user-420.png"/>
    <meta property="og:description" content="Simple, powerful visit tracking for Rails"/>

    <script src="//www.google.com/jsapi"></script>
    <script src="chartkick.js"></script>
  </head>
  <body>
    <a href="https://github.com/ankane/ahoy" style="position: fixed; top: 15px; right: 15px; border: 0; z-index: 1000;" class="btn btn-info">Github</a>

    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1 style="margin-bottom: 0.5em; margin-top: 15px;">Ahoy</h1>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <p class="lead"><img class="emoji" title=":fire:" alt=":fire:" src="https://github.global.ssl.fastly.net/images/icons/emoji/fire.png" height="20" width="20" align="absmiddle"> Simple, powerful visit tracking for Rails</p>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <hr style="margin-top: 0;" />

<!-- begin readme -->

<p>Visits are stored in <strong>your database</strong> so you can easily combine them with other data.</p>

<p>You get:</p>

<ul>
<li>
<strong>traffic source</strong> - referrer, referring domain, landing page, search keyword</li>
<li>
<strong>location</strong> - country, region, and city</li>
<li>
<strong>technology</strong> - browser, OS, and device type</li>
<li>
<strong>utm parameters</strong> - source, medium, term, content, campaign</li>
</ul><p>See which campaigns generate the most revenue effortlessly.</p>

<div class="highlight highlight-ruby"><pre><span class="no">Order</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:visit</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">"utm_campaign"</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="ss">:revenue</span><span class="p">)</span>
</pre></div>

<h2>
<a name="user-content-how-it-works" class="anchor" href="#how-it-works"><span class="octicon octicon-link"></span></a>How It Works</h2>

<p>When someone visits your website, Ahoy creates a visit with lots of useful information.</p>

<p>Use the <code>current_visit</code> method to access it.</p>

<p>Explore your visits with queries like:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Visit</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:search_keyword</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
<span class="no">Visit</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:country</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
<span class="no">Visit</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:referring_domain</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</pre></div>

<div id="chart-1" style="height: 300px; text-align: center; color: #999; line-height: 300px; font-size: 14px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Verdana, Arial, Helvetica, sans-serif;">
  Loading...
</div>
<script type="text/javascript">
  new Chartkick.LineChart("chart-1", {"2014-03-05 00:00:00 -0800":27,"2014-03-06 00:00:00 -0800":38,"2014-03-07 00:00:00 -0800":22,"2014-03-08 00:00:00 -0800":27,"2014-03-09 00:00:00 -0800":27,"2014-03-10 00:00:00 -0700":33,"2014-03-11 00:00:00 -0700":40,"2014-03-12 00:00:00 -0700":27,"2014-03-13 00:00:00 -0700":34,"2014-03-14 00:00:00 -0700":33,"2014-03-15 00:00:00 -0700":29,"2014-03-16 00:00:00 -0700":45,"2014-03-17 00:00:00 -0700":41,"2014-03-18 00:00:00 -0700":41}, {});
</script>

<p><a href="http://chartkick.com/">Chartkick</a> and <a href="https://github.com/ankane/groupdate">Groupdate</a> make it super easy to visualize the data.</p>

<div class="highlight highlight-erb"><pre><span class="cp">&lt;%=</span> <span class="n">line_chart</span> <span class="no">Visit</span><span class="o">.</span><span class="n">group_by_day</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>

<h3>
<a name="user-content-the-power" class="anchor" href="#the-power"><span class="octicon octicon-link"></span></a>The Power</h3>

<p>This information is great on its own, but super powerful when combined with other models.</p>

<p>Letâ€™s associate orders with visits.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">visitable</span>
<span class="k">end</span>
</pre></div>

<p>When a visitor places an order, the <code>visit_id</code> column is automatically set.</p>

<p><img class="emoji" title=":tada:" alt=":tada:" src="https://github.global.ssl.fastly.net/images/icons/emoji/tada.png" height="20" width="20" align="absmiddle"> Magic!</p>

<p>See where orders are coming from with simple joins:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Order</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:visit</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">"referring_domain"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
<span class="no">Order</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:visit</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">"city"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
<span class="no">Order</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:visit</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">"device_type"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</pre></div>

<h3>
<a name="user-content-users" class="anchor" href="#users"><span class="octicon octicon-link"></span></a>Users</h3>

<p>Ahoy automatically attaches the <code>current_user</code> to the <code>current_visit</code>.</p>

<p>If you define your own <code>current_user</code> method, be sure to add it to <code>ActionController::Base</code>, not <code>ApplicationController</code>.</p>

<p>With <a href="https://github.com/plataformatec/devise">Devise</a>, it will attach the user even if he / she signs in after the visit starts.</p>

<p>With other authentication frameworks, add this to the end of your sign in method:</p>

<div class="highlight highlight-ruby"><pre><span class="k">if</span> <span class="n">current_visit</span>
  <span class="n">current_visit</span><span class="o">.</span><span class="n">user</span> <span class="o">||=</span> <span class="n">current_user</span>
  <span class="n">current_visit</span><span class="o">.</span><span class="n">save!</span>
<span class="k">end</span>
</pre></div>

<p>To see the visits for a given user, create an association:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:visits</span>
<span class="k">end</span>
</pre></div>

<p>And use:</p>

<div class="highlight highlight-ruby"><pre><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="n">user</span><span class="o">.</span><span class="n">visits</span>
</pre></div>

<h3>
<a name="user-content-utm-parameters" class="anchor" href="#utm-parameters"><span class="octicon octicon-link"></span></a>UTM Parameters</h3>

<p>Use UTM parameters to track campaigns. <a href="http://www.thunderseo.com/blog/utm-parameters/">This is great for emails and social media</a>. Just add them to your links and Ahoy will pick them up.</p>

<pre><code>http://datakick.org/?utm_medium=email&amp;utm_campaign=newsletter&amp;utm_source=newsletter-2014-03
</code></pre>

<p>or</p>

<pre><code>http://datakick.org/?utm_medium=twitter&amp;utm_campaign=social&amp;utm_source=tweet123
</code></pre>

<h3>
<a name="user-content-location" class="anchor" href="#location"><span class="octicon octicon-link"></span></a>Location</h3>

<p>Ahoy uses <a href="https://github.com/alexreisner/geocoder">Geocoder</a> for IP-based geocoding.</p>

<h3>
<a name="user-content-multiple-subdomains" class="anchor" href="#multiple-subdomains"><span class="octicon octicon-link"></span></a>Multiple Subdomains</h3>

<p>To track visits across multiple subdomains, add this to your layout <strong>before</strong> the javascript files.</p>

<div class="highlight highlight-html"><pre><span class="nt">&lt;script&gt;</span>
  <span class="kd">var</span> <span class="nx">Ahoy</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"domain"</span><span class="o">:</span> <span class="s2">"yourdomain.com"</span><span class="p">};</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div>

<h3>
<a name="user-content-native-apps-master" class="anchor" href="#native-apps-master"><span class="octicon octicon-link"></span></a>Native Apps [master]</h3>

<p>When a user launches the app, create a visit.  Send a <code>POST</code> request to <code>/ahoy/visits</code> with:</p>

<ul>
<li>platform - <code>iOS</code>, <code>Android</code>, etc.</li>
<li>app_version - <code>1.0.0</code>
</li>
<li>os_version - <code>7.0.6</code>
</li>
<li>visitor_token - if you have one</li>
</ul><p>The endpoint will return a JSON response like:</p>

<div class="highlight highlight-json"><pre><span class="p">{</span>
  <span class="nt">"visit_token"</span><span class="p">:</span> <span class="s2">"8tx2ziymkwa1WlppnkqxyaBaRlXrEQ3K"</span><span class="p">,</span>
  <span class="nt">"visitor_token"</span><span class="p">:</span> <span class="s2">"hYBIV0rBfrIUAiArWweiECt4N9pyiygN"</span>
<span class="p">}</span>
</pre></div>

<p>Send the visit token in the <code>Ahoy-Visit</code> header for all requests.</p>

<p>After 4 hours, create another visit and use the updated visit token.</p>

<h3>
<a name="user-content-more" class="anchor" href="#more"><span class="octicon octicon-link"></span></a>More</h3>

<ul>
<li>Excludes bots</li>
<li>Degrades gracefully when cookies are disabled</li>
<li>Donâ€™t need a field? Just remove it from the migration</li>
</ul><h2>
<a name="user-content-installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Add this line to your applicationâ€™s Gemfile:</p>

<div class="highlight highlight-ruby"><pre><span class="n">gem</span> <span class="s1">'ahoy_matey'</span>
</pre></div>

<p>And run the generator. This creates a model to store visits.</p>

<div class="highlight highlight-sh"><pre>rails generate ahoy:install
rake db:migrate
</pre></div>

<p>Lastly, include the javascript file in <code>app/assets/javascripts/application.js</code> after jQuery.</p>

<div class="highlight highlight-javascript"><pre><span class="c1">//= require jquery</span>
<span class="c1">//= require ahoy</span>
</pre></div>

<p>We recommend using traditional analytics services like <a href="http://www.google.com/analytics/">Google Analytics</a> as well.</p>

<h2>
<a name="user-content-reference" class="anchor" href="#reference"><span class="octicon octicon-link"></span></a>Reference</h2>

<p>Use a different model</p>

<div class="highlight highlight-ruby"><pre><span class="no">Ahoy</span><span class="o">.</span><span class="n">visit_model</span> <span class="o">=</span> <span class="no">UserVisit</span>
</pre></div>

<p>Change the platform on the web</p>

<div class="highlight highlight-html"><pre><span class="nt">&lt;script&gt;</span>
  <span class="kd">var</span> <span class="nx">Ahoy</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"platform"</span><span class="o">:</span> <span class="s2">"Mobile Web"</span><span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div>

<h2>
<a name="user-content-todo" class="anchor" href="#todo"><span class="octicon octicon-link"></span></a>TODO</h2>

<ul>
<li>simple dashboard</li>
<li>hook to store additional fields</li>
<li>turn off modules</li>
</ul><h2>
<a name="user-content-history" class="anchor" href="#history"><span class="octicon octicon-link"></span></a>History</h2>

<p>View the <a href="https://github.com/ankane/ahoy/blob/master/CHANGELOG.md">changelog</a></p>

<h2>
<a name="user-content-contributing" class="anchor" href="#contributing"><span class="octicon octicon-link"></span></a>Contributing</h2>

<p>Everyone is encouraged to help improve this project. Here are a few ways you can help:</p>

<ul>
<li><a href="https://github.com/ankane/ahoy/issues">Report bugs</a></li>
<li>Fix bugs and <a href="https://github.com/ankane/ahoy/pulls">submit pull requests</a>
</li>
<li>Write, clarify, or fix documentation</li>
<li>Suggest or add new features</li>
</ul>

<!-- end readme -->

        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-39027070-8', 'ankane.github.io');
      ga('send', 'pageview');
    </script>

  </body>
</html>
